name: Deploy Frontend to EC2 K3s

on:
  push:
    branches:
      - develop
      - main

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: 774023531956.dkr.ecr.ap-northeast-2.amazonaws.com
  ECR_REPOSITORY: streamly-frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Clean up old ECR images
      run: |
        # ìµœì‹  5ê°œ ì´ë¯¸ì§€ë§Œ ìœ ì§€í•˜ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ
        IMAGE_IDS=$(aws ecr describe-images \
          --repository-name ${{ env.ECR_REPOSITORY }} \
          --query 'sort_by(imageDetails,& imagePushedAt)[:-5].[imageDigest]' \
          --output text)
        
        if [ ! -z "$IMAGE_IDS" ]; then
          echo "Deleting old images..."
          echo "$IMAGE_IDS" | while read digest; do
            aws ecr batch-delete-image \
              --repository-name ${{ env.ECR_REPOSITORY }} \
              --image-ids imageDigest=$digest
          done
          echo "âœ… Old images deleted"
        else
          echo "No old images to delete"
        fi

    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: ECR_REGISTRY,ECR_REPOSITORY,GITHUB_SHA,AWS_REGION
        script: |
          # ECR ë¡œê·¸ì¸
          aws ecr get-login-password --region ${AWS_REGION} | \
            docker login --username AWS --password-stdin ${ECR_REGISTRY}
          
          # ì´ë¯¸ì§€ íƒœê·¸
          IMAGE_TAG="${GITHUB_SHA}"
          NEW_IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          
          echo "Deploying frontend: ${NEW_IMAGE}"
          
          # K8s Deployment ì—…ë°ì´íŠ¸
          kubectl set image deployment/streamly-frontend \
            frontend=${NEW_IMAGE} \
            --record
          
          # ë°°í¬ ì™„ë£Œ ëŒ€ê¸° (5ë¶„ íƒ€ì„ì•„ì›ƒ)
          kubectl rollout status deployment/streamly-frontend --timeout=5m
          
          # ë°°í¬ í™•ì¸
          kubectl get pods -l app=streamly-frontend
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ (24ì‹œê°„ ì´ìƒ ëœ ì´ë¯¸ì§€)
          docker image prune -af --filter "until=24h"
          
          echo "âœ… Frontend deployment completed!"

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Health check
          sleep 10
          curl -f https://streamlyai.store || exit 1
          echo "âœ… Frontend health check passed!"

    - name: Rollback on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "âŒ Deployment failed! Rolling back..."
          kubectl rollout undo deployment/streamly-frontend
          kubectl rollout status deployment/streamly-frontend --timeout=3m
          echo "âª Frontend rollback completed!"

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Frontend deployment successful!"
          echo "ğŸ”— URL: https://streamlyai.store"
          echo "ğŸ“ Commit: ${{ github.sha }}"
        else
          echo "âŒ Frontend deployment failed!"
        fi
